// Copyright 2019 dfuse Platform Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package codec

import (
	"encoding/hex"
	"io"
	"os"
	"strings"
	"testing"

	pbcodec "github.com/dfuse-io/dfuse-solana/pb/dfuse/solana/codec/v1"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func Test_bank_sortTrx(t *testing.T) {
	b := &bank{
		batchAggregator: map[uint64][]*pbcodec.Transaction{
			1: []*pbcodec.Transaction{
				{Id: "dd"},
			},
			2: []*pbcodec.Transaction{
				{Id: "ee"},
			},
			0: []*pbcodec.Transaction{
				{Id: "bb"},
			},
			3: []*pbcodec.Transaction{
				{Id: "aa"},
				{Id: "cc"},
			},
			4: []*pbcodec.Transaction{
				{Id: "11"},
			},
		},
	}
	b.sortTrx()
	assert.Equal(t, []*pbcodec.Transaction{
		{Id: "11"},
		{Id: "aa"},
		{Id: "cc"},
		{Id: "bb"},
		{Id: "dd"},
		{Id: "ee"},
	}, b.sortedTrx)
}

func Test_readSlotWork(t *testing.T) {
	tests := []struct {
		name       string
		ctx        *parseCtx
		line       string
		expectCtx  *parseCtx
		expecError bool
	}{
		{
			name: "new full slot work",
			ctx: &parseCtx{
				banks: map[uint64]*bank{},
			},
			line: "SLOT_WORK 55295939 55295941 full 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 51936825 932 814 526 0 0 0 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 0",
			expectCtx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        932,
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						sortedTrx:       []*pbcodec.Transaction{},
						slots:           []*pbcodec.Slot{},
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
				activeBank: &bank{
					blockNum:        55295941,
					parentSlotNum:   55295939,
					trxCount:        932,
					batchAggregator: map[uint64][]*pbcodec.Transaction{},
					previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					sortedTrx:       []*pbcodec.Transaction{},
					slots:           []*pbcodec.Slot{},
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
				},
			},
		},
		{
			name: "new partial slot work",
			ctx: &parseCtx{
				banks: map[uint64]*bank{},
			},
			line: "SLOT_WORK 55295939 55295941 partial 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 51936825 932 814 526 0 0 0 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 0",
			expectCtx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        932,
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						sortedTrx:       []*pbcodec.Transaction{},
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						slots:           []*pbcodec.Slot{},
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
				activeBank: &bank{
					blockNum:        55295941,
					parentSlotNum:   55295939,
					trxCount:        932,
					previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					sortedTrx:       []*pbcodec.Transaction{},
					batchAggregator: map[uint64][]*pbcodec.Transaction{},
					slots:           []*pbcodec.Slot{},
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
				},
			},
		},
		{
			name: "known partial slot work",
			ctx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        932,
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
			},
			line: "SLOT_WORK 55295939 55295941 partial 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 51936825 423 814 526 0 0 0 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 0",
			expectCtx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        1355,
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
				activeBank: &bank{
					blockNum:        55295941,
					parentSlotNum:   55295939,
					trxCount:        1355,
					batchAggregator: map[uint64][]*pbcodec.Transaction{},
					previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
				},
			},
		},
		{
			name: "known full slot work",
			ctx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        932,
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
			},
			line: "SLOT_WORK 55295939 55295941 full 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 51936825 423 814 526 0 0 0 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 0",
			expectCtx: &parseCtx{
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:        55295941,
						parentSlotNum:   55295939,
						trxCount:        1355,
						batchAggregator: map[uint64][]*pbcodec.Transaction{},
						previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
				activeBank: &bank{
					blockNum:        55295941,
					parentSlotNum:   55295939,
					trxCount:        1355,
					batchAggregator: map[uint64][]*pbcodec.Transaction{},
					previousSlotID:  "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readSlotWork(test.line)
			if test.expecError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_readSlotEnd(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectSlot  *pbcodec.Slot
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "end slot",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
					sortedTrx:      trxSlice([]string{"a", "b", "c", "d"}),
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					slots: []*pbcodec.Slot{
						{
							Id:         "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
							Number:     55295941,
							PreviousId: "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
							Version:    1,
							Transactions: []*pbcodec.Transaction{
								{Id: "a", Index: 0, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
								{Id: "b", Index: 1, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
								{Id: "c", Index: 2, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
								{Id: "d", Index: 3, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
							},
							TransactionCount: 4,
							Block: &pbcodec.Block{
								Id:                   "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
								Number:               55295941,
								Height:               51936825,
								PreviousId:           "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
								PreviousBlockSlot:    55295939,
								GenesisUnixTimestamp: 1606487316,
								ClockUnixTimestamp:   1606487316,
							},
						},
					},
				},
				banks: map[uint64]*bank{
					55295941: &bank{
						blockNum:       55295941,
						parentSlotNum:  55295939,
						trxCount:       932,
						previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
						blk: &pbcodec.Block{
							Number:            55295941,
							Height:            51936825,
							PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
							PreviousBlockSlot: 55295939,
						},
					},
				},
				slotBuffer: make(chan *pbcodec.Slot, 100),
			},
			line: "SLOT_END 55295941 3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz 1606487316 1606487316",
			expectSlot: &pbcodec.Slot{
				Id:         "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
				Number:     55295941,
				PreviousId: "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
				Version:    1,
				Transactions: []*pbcodec.Transaction{
					{Id: "a", Index: 0, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
					{Id: "b", Index: 1, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
					{Id: "c", Index: 2, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
					{Id: "d", Index: 3, SlotNum: 55295941, SlotHash: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz"},
				},
				TransactionCount: 4,
				Block: &pbcodec.Block{
					Id:                   "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					Number:               55295941,
					Height:               51936825,
					PreviousId:           "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					PreviousBlockSlot:    55295939,
					GenesisUnixTimestamp: 1606487316,
					ClockUnixTimestamp:   1606487316,
				},
			},
			expectCtx: &parseCtx{
				activeBank: nil,
				banks:      map[uint64]*bank{},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readSlotEnd(test.line)
			require.NoError(t, err)
			assert.Equal(t, 1, len(test.ctx.slotBuffer))
			slot := <-test.ctx.slotBuffer
			assert.Equal(t, test.expectSlot, slot)
		})
	}
}

func Test_readSlotBound(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectSlot  *pbcodec.Slot
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "end slot",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
					sortedTrx:      []*pbcodec.Transaction{},
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
				},
				slotBuffer: make(chan *pbcodec.Slot, 100),
			},
			line: "SLOT_BOUND 55295940 5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
			expectSlot: &pbcodec.Slot{
				Id:               "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
				Number:           55295940,
				PreviousId:       "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
				Version:          1,
				TransactionCount: 0,
			},
			expectCtx: &parseCtx{
				activeBank: nil,
				banks:      map[uint64]*bank{},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readSlotBound(test.line)
			require.NoError(t, err)
			assert.Equal(t, 1, len(test.ctx.activeBank.slots))
			slot := test.ctx.activeBank.slots[0]
			assert.Equal(t, test.expectSlot, slot)
		})
	}
}

func Test_readTransactionStart(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "golden path",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{},
				},
			},
			line: "TRX_START 0 3JwX7ifk5BYZWdBK1o9Zs4wEZ6HP8MWbxhgZD7u1PzSDbaDLrZZbhBnvQJsVMPpWdpaTAFiUiQWZcbEdc3Nfj9Sq 1 0 3 3rqEEEGjHRyndHuduBcjkf17rX3hgmGACpYTQYeZ5Ltk:8xV77wuFP5BkMDdb1845hRRWZNbDNAbcV75BjMuViWpf:SysvarS1otHashes111111111111111111111111111:SysvarC1ock11111111111111111111111111111111:Vote111111111111111111111111111111111111111 2pE6pkNJzuMz4r8owVi4hrCctEvGyrg1g3SLD4nbcsxz",
			expectCtx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						0: []*pbcodec.Transaction{
							{
								Id:                   "3JwX7ifk5BYZWdBK1o9Zs4wEZ6HP8MWbxhgZD7u1PzSDbaDLrZZbhBnvQJsVMPpWdpaTAFiUiQWZcbEdc3Nfj9Sq",
								AdditionalSignatures: []string{},
								Header: &pbcodec.MessageHeader{
									NumRequiredSignatures:       1,
									NumReadonlySignedAccounts:   0,
									NumReadonlyUnsignedAccounts: 3,
								},
								AccountKeys: []string{
									"3rqEEEGjHRyndHuduBcjkf17rX3hgmGACpYTQYeZ5Ltk",
									"8xV77wuFP5BkMDdb1845hRRWZNbDNAbcV75BjMuViWpf",
									"SysvarS1otHashes111111111111111111111111111",
									"SysvarC1ock11111111111111111111111111111111",
									"Vote111111111111111111111111111111111111111",
								},
								RecentBlockhash: "2pE6pkNJzuMz4r8owVi4hrCctEvGyrg1g3SLD4nbcsxz",
							},
						},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readTransactionStart(test.line)
			if test.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_readTransactionLog(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "golden path",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						1: []*pbcodec.Transaction{
							{
								Id: "aaa",
							},
						},
					},
				},
			},
			line: "TRX_L 1 aaa aabbcc",
			expectCtx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						1: []*pbcodec.Transaction{
							{
								Id: "aaa",
								LogMessages: []string{
									"\xaa\xbb\xcc",
								},
							},
						},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readTransactionLog(test.line)
			if test.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_readInstructionStart(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "golden path",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						3: []*pbcodec.Transaction{
							{
								Id: "S5eYZCYnXoa3858MJ2cvdXCXRW8xiTagWXM4WNggt96A5qm2NoHtYro56GGwygCgfKJzN733PxMBEEH7TAoHRYh",
							},
						},
					},
				},
			},
			line: "INST_S 3 S5eYZCYnXoa3858MJ2cvdXCXRW8xiTagWXM4WNggt96A5qm2NoHtYro56GGwygCgfKJzN733PxMBEEH7TAoHRYh 1 0 Vote111111111111111111111111111111111111111 020000000200000000000000adbf4b0300000000aebf4b03000000000e060473b5c277d1949ddc92c7a92e2d835008d70fd4817b5110611c11d52aa801c214d85f00000000 Vote111111111111111111111111111111111111111:00;9SE5oHdQ88rVFPcJZjn7fNGSXhU7JQfZ5Vks1h5VNCWj:01;SysvarS1otHashes111111111111111111111111111:00;SysvarC1ock11111111111111111111111111111111:00;AHg5MDTTPKvfCxYy8Zb3NpRYG7ixsx2uTT1MUs7DwzEu:11",
			expectCtx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						3: []*pbcodec.Transaction{
							{
								Id: "S5eYZCYnXoa3858MJ2cvdXCXRW8xiTagWXM4WNggt96A5qm2NoHtYro56GGwygCgfKJzN733PxMBEEH7TAoHRYh",
								Instructions: []*pbcodec.Instruction{
									{
										ProgramId: "Vote111111111111111111111111111111111111111",
										AccountKeys: []string{
											"Vote111111111111111111111111111111111111111",
											"9SE5oHdQ88rVFPcJZjn7fNGSXhU7JQfZ5Vks1h5VNCWj",
											"SysvarS1otHashes111111111111111111111111111",
											"SysvarC1ock11111111111111111111111111111111",
											"AHg5MDTTPKvfCxYy8Zb3NpRYG7ixsx2uTT1MUs7DwzEu",
										},
										Data:    mustHexDecode("020000000200000000000000adbf4b0300000000aebf4b03000000000e060473b5c277d1949ddc92c7a92e2d835008d70fd4817b5110611c11d52aa801c214d85f00000000"),
										Ordinal: 1,
									},
								},
							},
						},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readInstructionStart(test.line)
			if test.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_readAccountChange(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "golden path",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						0: []*pbcodec.Transaction{
							{
								Id: "4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i",
								Instructions: []*pbcodec.Instruction{
									{
										AccountChanges: []*pbcodec.AccountChange{},
									},
								},
							},
						},
					},
				},
			},
			line: "ACCT_CH 0 4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i 1 2xjAQsHLsV36NLFkxdApzLg4SNqm15mNqYaBQ4xp5joh 01000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e95ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950a1f000000000000007abf4b03000000001f0000007bbf4b03000000001e0000007cbf4b03000000001d0000008cbf4b03000000001c0000008dbf4b03000000001b0000008ebf4b03000000001a0000008fbf4b03000000001900000091bf4b03000000001800000092bf4b03000000001700000093bf4b03000000001600000094bf4b03000000001500000095bf4b03000000001400000096bf4b03000000001300000097bf4b03000000001200000098bf4b03000000001100000099bf4b0300000000100000009abf4b03000000000f0000009bbf4b03000000000e0000009cbf4b03000000000d0000009dbf4b03000000000c0000009ebf4b03000000000b0000009fbf4b03000000000a000000a0bf4b030000000009000000a1bf4b030000000008000000a2bf4b030000000007000000a3bf4b030000000006000000a4bf4b030000000005000000a5bf4b030000000004000000a6bf4b030000000003000000a7bf4b030000000002000000a8bf4b0300000000010000000179bf4b030000000001000000000000007f00000000000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f000000000000000112000000000000006e00000000000000fa9601000000000000000000000000006f00000000000000e175070000000000fa9601000000000070000000000000002c7b0d0000000000e175070000000000710000000000000000531300000000002c7b0d0000000000720000000000000093081900000000000053130000000000730000000000000026cb1e000000000093081900000000007400000000000000b60624000000000026cb1e00000000007500000000000000b6fb280000000000b6062400000000007600000000000000a9332e0000000000b6fb28000000000077000000000000002631330000000000a9332e00000000007800000000000000ba4738000000000026313300000000007900000000000000219b3c0000000000ba473800000000007a0000000000000025a6410000000000219b3c00000000007b00000000000000f71847000000000025a64100000000007c00000000000000e68f4c0000000000f7184700000000007d0000000000000075d74f0000000000e68f4c00000000007e00000000000000e78253000000000075d74f00000000007f000000000000000c96570000000000e782530000000000a8bf4b0300000000bf14d85f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 01000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e95ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950a1f000000000000007bbf4b03000000001f0000007cbf4b03000000001e0000008cbf4b03000000001d0000008dbf4b03000000001c0000008ebf4b03000000001b0000008fbf4b03000000001a00000091bf4b03000000001900000092bf4b03000000001800000093bf4b03000000001700000094bf4b03000000001600000095bf4b03000000001500000096bf4b03000000001400000097bf4b03000000001300000098bf4b03000000001200000099bf4b0300000000110000009abf4b0300000000100000009bbf4b03000000000f0000009cbf4b03000000000e0000009dbf4b03000000000d0000009ebf4b03000000000c0000009fbf4b03000000000b000000a0bf4b03000000000a000000a1bf4b030000000009000000a2bf4b030000000008000000a3bf4b030000000007000000a4bf4b030000000006000000a5bf4b030000000005000000a6bf4b030000000004000000a7bf4b030000000003000000a8bf4b030000000002000000a9bf4b030000000001000000017abf4b030000000001000000000000007f00000000000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f000000000000000112000000000000006e00000000000000fa9601000000000000000000000000006f00000000000000e175070000000000fa9601000000000070000000000000002c7b0d0000000000e175070000000000710000000000000000531300000000002c7b0d0000000000720000000000000093081900000000000053130000000000730000000000000026cb1e000000000093081900000000007400000000000000b60624000000000026cb1e00000000007500000000000000b6fb280000000000b6062400000000007600000000000000a9332e0000000000b6fb28000000000077000000000000002631330000000000a9332e00000000007800000000000000ba4738000000000026313300000000007900000000000000219b3c0000000000ba473800000000007a0000000000000025a6410000000000219b3c00000000007b00000000000000f71847000000000025a64100000000007c00000000000000e68f4c0000000000f7184700000000007d0000000000000075d74f0000000000e68f4c00000000007e00000000000000e78253000000000075d74f00000000007f000000000000000d96570000000000e782530000000000a9bf4b0300000000bf14d85f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			expectCtx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						0: []*pbcodec.Transaction{
							{
								Id: "4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i",
								Instructions: []*pbcodec.Instruction{
									{
										AccountChanges: []*pbcodec.AccountChange{
											{
												Pubkey:        "2xjAQsHLsV36NLFkxdApzLg4SNqm15mNqYaBQ4xp5joh",
												PrevData:      mustHexDecode("01000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e95ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950a1f000000000000007abf4b03000000001f0000007bbf4b03000000001e0000007cbf4b03000000001d0000008cbf4b03000000001c0000008dbf4b03000000001b0000008ebf4b03000000001a0000008fbf4b03000000001900000091bf4b03000000001800000092bf4b03000000001700000093bf4b03000000001600000094bf4b03000000001500000095bf4b03000000001400000096bf4b03000000001300000097bf4b03000000001200000098bf4b03000000001100000099bf4b0300000000100000009abf4b03000000000f0000009bbf4b03000000000e0000009cbf4b03000000000d0000009dbf4b03000000000c0000009ebf4b03000000000b0000009fbf4b03000000000a000000a0bf4b030000000009000000a1bf4b030000000008000000a2bf4b030000000007000000a3bf4b030000000006000000a4bf4b030000000005000000a5bf4b030000000004000000a6bf4b030000000003000000a7bf4b030000000002000000a8bf4b0300000000010000000179bf4b030000000001000000000000007f00000000000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f000000000000000112000000000000006e00000000000000fa9601000000000000000000000000006f00000000000000e175070000000000fa9601000000000070000000000000002c7b0d0000000000e175070000000000710000000000000000531300000000002c7b0d0000000000720000000000000093081900000000000053130000000000730000000000000026cb1e000000000093081900000000007400000000000000b60624000000000026cb1e00000000007500000000000000b6fb280000000000b6062400000000007600000000000000a9332e0000000000b6fb28000000000077000000000000002631330000000000a9332e00000000007800000000000000ba4738000000000026313300000000007900000000000000219b3c0000000000ba473800000000007a0000000000000025a6410000000000219b3c00000000007b00000000000000f71847000000000025a64100000000007c00000000000000e68f4c0000000000f7184700000000007d0000000000000075d74f0000000000e68f4c00000000007e00000000000000e78253000000000075d74f00000000007f000000000000000c96570000000000e782530000000000a8bf4b0300000000bf14d85f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
												NewData:       mustHexDecode("01000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e95ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950a1f000000000000007bbf4b03000000001f0000007cbf4b03000000001e0000008cbf4b03000000001d0000008dbf4b03000000001c0000008ebf4b03000000001b0000008fbf4b03000000001a00000091bf4b03000000001900000092bf4b03000000001800000093bf4b03000000001700000094bf4b03000000001600000095bf4b03000000001500000096bf4b03000000001400000097bf4b03000000001300000098bf4b03000000001200000099bf4b0300000000110000009abf4b0300000000100000009bbf4b03000000000f0000009cbf4b03000000000e0000009dbf4b03000000000d0000009ebf4b03000000000c0000009fbf4b03000000000b000000a0bf4b03000000000a000000a1bf4b030000000009000000a2bf4b030000000008000000a3bf4b030000000007000000a4bf4b030000000006000000a5bf4b030000000005000000a6bf4b030000000004000000a7bf4b030000000003000000a8bf4b030000000002000000a9bf4b030000000001000000017abf4b030000000001000000000000007f00000000000000ed76cf23520b41e64596066fc8dbf63e94e1b5e97add78d9501f796142b17e950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f000000000000000112000000000000006e00000000000000fa9601000000000000000000000000006f00000000000000e175070000000000fa9601000000000070000000000000002c7b0d0000000000e175070000000000710000000000000000531300000000002c7b0d0000000000720000000000000093081900000000000053130000000000730000000000000026cb1e000000000093081900000000007400000000000000b60624000000000026cb1e00000000007500000000000000b6fb280000000000b6062400000000007600000000000000a9332e0000000000b6fb28000000000077000000000000002631330000000000a9332e00000000007800000000000000ba4738000000000026313300000000007900000000000000219b3c0000000000ba473800000000007a0000000000000025a6410000000000219b3c00000000007b00000000000000f71847000000000025a64100000000007c00000000000000e68f4c0000000000f7184700000000007d0000000000000075d74f0000000000e68f4c00000000007e00000000000000e78253000000000075d74f00000000007f000000000000000d96570000000000e782530000000000a9bf4b0300000000bf14d85f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
												NewDataLength: 3731,
											},
										},
									},
								},
							},
						},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readAccountChange(test.line)
			if test.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_readLamportsChange(t *testing.T) {
	tests := []struct {
		name        string
		ctx         *parseCtx
		line        string
		expectCtx   *parseCtx
		expectError bool
	}{
		{
			name: "golden path",
			ctx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						0: []*pbcodec.Transaction{
							{
								Id: "4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i",
								Instructions: []*pbcodec.Instruction{
									{
										BalanceChanges: []*pbcodec.BalanceChange{},
									},
								},
							},
						},
					},
				},
			},
			line: "LAMP_CH 0 4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i 1 11111111111111111111111111111111 499999892500 494999892500",
			expectCtx: &parseCtx{
				activeBank: &bank{
					blockNum:       55295941,
					parentSlotNum:  55295939,
					trxCount:       932,
					previousSlotID: "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
					blk: &pbcodec.Block{
						Number:            55295941,
						Height:            51936825,
						PreviousId:        "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
						PreviousBlockSlot: 55295939,
					},
					batchAggregator: map[uint64][]*pbcodec.Transaction{
						0: []*pbcodec.Transaction{
							{
								Id: "4YU3GFLmzR7b58YDgNCwHD3YfEHTLq7b13gSr3zWHWa4W7FuvBrWQgLnvQT4kfxJ5ZTULokJK7x2d7nfKU3UWd8i",
								Instructions: []*pbcodec.Instruction{
									{
										BalanceChanges: []*pbcodec.BalanceChange{
											{
												Pubkey:       "11111111111111111111111111111111",
												PrevLamports: 499999892500,
												NewLamports:  494999892500,
											},
										},
									},
								},
							},
						},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			err := test.ctx.readLamportsChange(test.line)
			if test.expectError {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, test.expectCtx, test.ctx)
			}
		})
	}
}

func Test_SimpleSlotWithBound(t *testing.T) {
	expectSlots := []*pbcodec.Slot{
		{
			Id:         "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
			Number:     55295940,
			PreviousId: "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
			Version:    1,
			Block: &pbcodec.Block{
				Id:                   "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
				Number:               55295941,
				Height:               51936825,
				PreviousId:           "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
				PreviousBlockSlot:    55295939,
				GenesisUnixTimestamp: 1606487316,
				ClockUnixTimestamp:   1606487316,
			},
		},
		{
			Id:         "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
			Number:     55295941,
			PreviousId: "5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae",
			Version:    1,
			Block: &pbcodec.Block{
				Id:                   "3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz",
				Number:               55295941,
				Height:               51936825,
				PreviousId:           "8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr",
				PreviousBlockSlot:    55295939,
				GenesisUnixTimestamp: 1606487316,
				ClockUnixTimestamp:   1606487316,
			},
		},
	}
	cnt := `
DMLOG SLOT_WORK 55295939 55295941 full 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 51936825 932 814 526 0 0 0 8iCeHcXf6o7Qi8UjYzjoVqo2AUEyo3tpd9V7yVgCesNr 0
DMLOG SLOT_BOUND 55295940 5XcRYrCbLFGSACy43fRdG4zJ88tWxB3eSx36MePjy3Ae
DMLOG SLOT_BOUND 55295941 3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz
DMLOG SLOT_END 55295941 3HfUeXfBt8XFHRiyrfhh5EXvFnJTjMHxzemy8DueaUFz 1606487316 1606487316
`

	cr, err := NewConsoleReader(strings.NewReader(cnt))
	require.NoError(t, err)

	for _, expectSlot := range expectSlots {
		o, err := cr.Read()
		if err != io.EOF {
			require.NoError(t, err)
		}
		assert.Equal(t, expectSlot, o)
	}
}

func Test_SimpleSlotFromFile(t *testing.T) {
	f, err := os.Open("./test_data/simple.55295915.dmlog")
	require.NoError(t, err)

	cr, err := NewConsoleReader(f)
	require.NoError(t, err)

	s, err := cr.Read()
	require.NoError(t, err)

	slot := s.(*pbcodec.Slot)
	// TODO: add more testing
	assert.Equal(t, "HGRz1p4Eh4wvxWFq8Ki1Jj2uatx2XashQMZhhyMsqNtB", slot.Id)
	assert.Equal(t, "BhGksZQu7eNNRYm9A2ZafCAgGTKwubN4FF68Y2VYq4ET", slot.PreviousId)
	assert.Equal(t, uint64(55295915), slot.Num())
	assert.Equal(t, uint32(465), slot.TransactionCount)
	transaction := slot.Transactions[0]
	assert.Equal(t, "22yEKbnjpxVJQY7RMuvJEYc5PoBVFEFYJCT6Ak2xrtNT7ppzePwneGGuzK2BNEdvdFsvUQHu1qnS688VccHPVKxJ", transaction.Id)
	assert.Equal(t, 1, len(transaction.Instructions))

	_, err = cr.Read()
	assert.Equal(t, err, io.EOF)
}

func Test_VirtualSlotFromFile(t *testing.T) {
	f, err := os.Open("./test_data/dual.55295925.dmlog")
	require.NoError(t, err)

	cr, err := NewConsoleReader(f)
	require.NoError(t, err)

	s, err := cr.Read()
	require.NoError(t, err)

	slot := s.(*pbcodec.Slot)
	// TODO: add more testing
	assert.Equal(t, "7DDxS2s6AUJLG66V1SmeQ1zhM8o7vaGAVZvr87TVdYDm", slot.Id)
	assert.Equal(t, "72P3ABBhVV1zR25DxUdFAMmfXf8EMAoSBBZ3tnqJK9nh", slot.PreviousId)
	assert.Equal(t, uint64(55295924), slot.Num())
	assert.Equal(t, uint32(0), slot.TransactionCount)

	s, err = cr.Read()
	require.NoError(t, err)
	slot = s.(*pbcodec.Slot)

	// TODO: add more testing
	assert.Equal(t, "2vyQNcg2ppuEEdV8M9tKouQMNi1iUmgqWTdtLiepyFhJ", slot.Id)
	assert.Equal(t, "7DDxS2s6AUJLG66V1SmeQ1zhM8o7vaGAVZvr87TVdYDm", slot.PreviousId)
	assert.Equal(t, uint64(55295925), slot.Num())
	assert.Equal(t, uint32(538), slot.TransactionCount)
	transaction := slot.Transactions[0]
	assert.Equal(t, "2C2196XJ7seoTfVxa8ToTfPemdW5gzo9i8wyKPEfZ9zL9wxz1PKJRhqZDRNqNQcXKZqZPuGUtDk6MKi8sddZD6Nt", transaction.Id)
	assert.Equal(t, 1, len(transaction.Instructions))

	_, err = cr.Read()
	assert.Equal(t, err, io.EOF)
}

func mustHexDecode(d string) []byte {
	b, e := hex.DecodeString(d)
	if e != nil {
		panic(e)
	}
	return b
}

func trxSlice(trxIDs []string) (out []*pbcodec.Transaction) {
	for _, trxID := range trxIDs {
		out = append(out, &pbcodec.Transaction{Id: trxID})
	}
	return
}
